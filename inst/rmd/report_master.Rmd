---
title: "AlphaGenome Variant Analysis Report"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: flatly
    toc: true
    toc_float: true
    code_folding: hide
params:
  obj: NULL
---

```{r setup, include=FALSE} 
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE) 
library(AlphaVaR) 
library(dplyr) 
library(ggplot2)
library(DT) 
library(plotly)
```

1.  Overview & QC

Here is a summary of the imported dataset.

```{r}
# Zugriff auf das Objekt via params$obj
qc <- av_qc_summary(params$obj)
DT::datatable(qc, options = list(dom = 't'))
av_plot_qc_dist(params$obj)
```

2.  Modality Enrichment

Statistical assessment of variant scores across assays.

```{r}
p <- av_plot_ridges(params$obj) 
print(p)
```

Statistical Results (Fisher & Wilcoxon)

```{r}

if (!is.null(params$obj$stats$enrichment)) {
  res <- params$obj$stats$enrichment %>% select(group, n_hits, log2OR, neg_log10_fdr, class = p_adj) %>% mutate(significance = ifelse(class < 0.05, "Significant", "NS"))

DT::datatable(res, filter = 'top') } else { print("No statistics computed yet.") }
```

Volcano Plot
```{r}

if (!is.null(params$obj$stats$enrichment)) {
  p_vol <- av_plot_volcano(params$obj) 
  print(plotly::ggplotly(p_vol, tooltip = c("label", "x", "y"))) }
```

3.  Gene Burden Analysis

Which genes are most affected by the variants?
```{r}

# Top 20 Genes Plot
genes <- av_aggregate_genes(params$obj, method = "max") 
top_genes <- head(genes, 20)

ggplot(top_genes, aes(x = reorder(gene, gene_score), y = gene_score)) + geom_col(fill = "steelblue") + coord_flip() + labs(title = "Top 20 Affected Genes (Max Score)", x = NULL, y = "Max Absolute Score") + theme_minimal()
```

Full Gene Table
```{r}

DT::datatable(genes, filter = 'top')
```

Report generated by AlphaVaR